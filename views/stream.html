<!DOCTYPE html>
<html>

<head>
    <title>WebSocket Test Sender</title>
    <script>
        var RTCPeer = new RTCPeerConnection();
        var socket = new WebSocket("wss://kyj9447.iptime.org:3000");
        // const reader = new FileReader();

        // 1. Submit 버튼 클릭 시
        async function startChat(event) {
            // 기본 이벤트 제거 (없으면 페이지 새로고침됨)
            event.preventDefault();

            // 입력값 가져오기
            var roomrequest = document.getElementById('roomrequest').value;
            var username = document.getElementById('username').value;

            // 본인 카메라 스트림 시작 및 offer 생성
            const offer = await startStream();

            // JSON으로 메시지 생성
            var message = {
                type: "login",
                roomrequest: roomrequest,
                username: username,
                rtc: offer
            };
            socket.send(JSON.stringify(message));
            // console.log("Sent message: " + JSON.stringify(message));
        }

        // 2. 소켓이 메시지를 받았을 때
        socket.onmessage = function (event) {
            console.log("Received message: " + event.data);
            // 받은 메세지를 JSON으로 파싱
            const data = JSON.parse(event.data);
            // 각 변수에 저장
            const { type, roomrequest, username, rtc } = data;

            // type별 처리
            if (type === "offer") {
                // 1.offer를 받았을 때
                console.log("Received offer: " + rtc);
                RTCPeer.setRemoteDescription(rtc);
                const answer = RTCPeer.createAnswer();
                RTCPeer.setLocalDescription(answer);
                const message = {
                    type: "answer",
                    //roomrequest: roomrequest,
                    //username: username,
                    rtc: answer
                };
                socket.send(JSON.stringify(message));
            } 
            
            else if (type === "answer") {
                // 2.answer를 받았을 때
                console.log("Received answer: " + rtc);
                RTCPeer.setRemoteDescription(rtc);
            } 
            
            else if (type === "candidate") {
                // 3.candidate를 받았을 때
                console.log("Received candidate: " + rtc);
                RTCPeer.addIceCandidate(rtc);
                // candidate 교환이 끝난 후 비디오, 오디오 스트림을 HTML 태그에 추가
                RTCPeer.ontrack = function (event) {
                    // 비디오 태그에 스트림 추가
                    const videoElement = document.getElementById('video');
                    if (!videoElement.srcObject) {
                        videoElement.srcObject = event.streams[0];
                    }
                };

                RTCPeer.onaddstream = function (event) {
                    // 오디오 태그에 스트림 추가
                    const audioElement = document.getElementById('audio');
                    if (!audioElement.srcObject) {
                        audioElement.srcObject = event.stream;
                    }
                };
            } 
            
            else if (type === "login") {
                // 4.login을 받았을 때
                console.log("Login: " + username);
                var message = username + "님이 로그인하였습니다";
                var paragraph = document.createElement("p");
                var text = document.createTextNode(message);
                paragraph.appendChild(text);
                document.body.appendChild(paragraph);
            } 

            else if (type === "logout") {
                // 5.logout을 받았을 때
                console.log("Logout: " + username);
                var message = username + "님이 로그아웃하였습니다";
                var paragraph = document.createElement("p");
                var text = document.createTextNode(message);
                paragraph.appendChild(text);
                document.body.appendChild(paragraph);
            }
        };

        // 3. 로컬 스트림 시작 및 offer 생성 함수
        async function startStream() {
            // 웹캠 스트림 가져오기
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

            // 비디오 태그에 스트림 추가
            document.getElementById('video').srcObject = stream;

            // RTCPeerConnection에 스트림 추가
            stream.getTracks().forEach(track => RTCPeer.addTrack(track, stream));

            // offer 생성
            const offer = await RTCPeer.createOffer();

            // offer에 로컬 설명 추가
            await RTCPeer.setLocalDescription(offer);

            // offer 리턴
            return RTCPeer.localDescription;
        }


    </script>
</head>

<body>
    <h1>WebSocket Test Sender</h1>
    <form onsubmit="startChat(event)">
        <label for="roomrequest">Room Request:</label><br>
        <input type="text" id="roomrequest" name="roomrequest"><br>
        <label for="username">Username:</label><br>
        <input type="text" id="username" name="username"><br>
        <input type="submit" value="Submit">
    </form>
    <video id='video' autoplay controls width="320" height="240"></video>
</body>

</html>